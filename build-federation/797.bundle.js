"use strict";(self.webpackChunkciqo=self.webpackChunkciqo||[]).push([[797],{60797:function(t,e,n){n.r(e),n.d(e,{AVERAGE:function(){return d},CENTER:function(){return c},CONTAINED:function(){return h},ExtendedTriangle:function(){return q},FloatVertexAttributeTexture:function(){return pe},INTERSECTED:function(){return v},IntVertexAttributeTexture:function(){return he},MeshBVH:function(){return Xt},MeshBVHUniformStruct:function(){return ye},MeshBVHVisualizer:function(){return Jt},NOT_INTERSECTED:function(){return l},OrientedBox:function(){return W},SAH:function(){return f},StaticGeometryGenerator:function(){return Ee},UIntVertexAttributeTexture:function(){return ve},VertexAttributeTexture:function(){return le},acceleratedRaycast:function(){return ue},computeBoundsTree:function(){return ce},disposeBoundsTree:function(){return de},estimateMemoryInBytes:function(){return ne},getBVHExtremes:function(){return ee},getJSONStructure:function(){return ie},getTriangleHitPointInfo:function(){return ft},shaderIntersectFunction:function(){return ge},shaderStructs:function(){return me},validateBounds:function(){return re}});var r=n(63931),i=n(30070),a=n(2721),o=n(54314),s=n(55248),u=n(56289),c=0,d=1,f=2,l=0,v=1,h=2,p=1.25,y=32,m=65535,g=Math.pow(2,-24),x=n(39544),b=(0,s.Z)((function t(){(0,o.Z)(this,t)}));function w(t,e,n){return n.min.x=e[t],n.min.y=e[t+1],n.min.z=e[t+2],n.max.x=e[t+3],n.max.y=e[t+4],n.max.z=e[t+5],n}function B(t){for(var e=-1,n=-1/0,r=0;r<3;r++){var i=t[r+3]-t[r];i>n&&(n=i,e=r)}return e}function T(t,e){e.set(t)}function A(t,e,n){for(var r,i,a=0;a<3;a++){var o=a+3;r=t[a],i=e[a],n[a]=r<i?r:i,r=t[o],i=e[o],n[o]=r>i?r:i}}function M(t,e,n){for(var r=0;r<3;r++){var i=e[t+2*r],a=e[t+2*r+1],o=i-a,s=i+a;o<n[r]&&(n[r]=o),s>n[r+3]&&(n[r+3]=s)}}function I(t){var e=t[3]-t[0],n=t[4]-t[1],r=t[5]-t[2];return 2*(e*n+n*r+r*e)}function P(t,e,n,r){for(var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=1/0,o=1/0,s=1/0,u=-1/0,c=-1/0,d=-1/0,f=1/0,l=1/0,v=1/0,h=-1/0,p=-1/0,y=-1/0,m=null!==i,g=6*e,x=6*(e+n);g<x;g+=6){var b=t[g+0],w=t[g+1],B=b-w,T=b+w;B<a&&(a=B),T>u&&(u=T),m&&b<f&&(f=b),m&&b>h&&(h=b);var A=t[g+2],M=t[g+3],I=A-M,P=A+M;I<o&&(o=I),P>c&&(c=P),m&&A<l&&(l=A),m&&A>p&&(p=A);var F=t[g+4],S=t[g+5],V=F-S,k=F+S;V<s&&(s=V),k>d&&(d=k),m&&F<v&&(v=F),m&&F>y&&(y=F)}r[0]=a,r[1]=o,r[2]=s,r[3]=u,r[4]=c,r[5]=d,m&&(i[0]=f,i[1]=l,i[2]=v,i[3]=h,i[4]=p,i[5]=y)}function F(t,e,n,r,i){for(var a=n,o=n+r-1,s=i.pos,u=2*i.axis;;){for(;a<=o&&e[6*a+u]<s;)a++;for(;a<=o&&e[6*o+u]>=s;)o--;if(!(a<o))return a;for(var c=0;c<3;c++){var d=t[3*a+c];t[3*a+c]=t[3*o+c],t[3*o+c]=d;var f=e[6*a+2*c+0];e[6*a+2*c+0]=e[6*o+2*c+0],e[6*o+2*c+0]=f;var l=e[6*a+2*c+1];e[6*a+2*c+1]=e[6*o+2*c+1],e[6*o+2*c+1]=l}a++,o--}}var S=32,V=function(t,e){return t.candidate-e.candidate},k=new Array(S).fill().map((function(){return{count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}})),D=new Float32Array(6);function U(t,e,n,r,i,a){var o=-1,s=0;if(a===c)-1!==(o=B(e))&&(s=(e[o]+e[o+3])/2);else if(a===d)-1!==(o=B(t))&&(s=function(t,e,n,r){for(var i=0,a=e,o=e+n;a<o;a++)i+=t[6*a+2*r];return i/n}(n,r,i,o));else if(a===f)for(var u=I(t),l=p*i,v=6*r,h=6*(r+i),y=0;y<3;y++){var m=e[y],g=(e[y+3]-m)/S;if(i<8){var b=(0,x.Z)(k);b.length=i;for(var w=0,P=v;P<h;P+=6,w++){var F=b[w];F.candidate=n[P+2*y],F.count=0;for(var U=F.bounds,z=F.leftCacheBounds,Z=F.rightCacheBounds,E=0;E<3;E++)Z[E]=1/0,Z[E+3]=-1/0,z[E]=1/0,z[E+3]=-1/0,U[E]=1/0,U[E+3]=-1/0;M(P,n,U)}b.sort(V);for(var N=i,_=0;_<N;_++)for(var G=b[_];_+1<N&&b[_+1].candidate===G.candidate;)b.splice(_+1,1),N--;for(var R=v;R<h;R+=6)for(var C=n[R+2*y],O=0;O<N;O++){var H=b[O];C>=H.candidate?M(R,n,H.rightCacheBounds):(M(R,n,H.leftCacheBounds),H.count++)}for(var L=0;L<N;L++){var q=b[L],W=q.count,X=i-q.count,Y=q.leftCacheBounds,j=q.rightCacheBounds,J=0;0!==W&&(J=I(Y)/u);var K=0;0!==X&&(K=I(j)/u);var Q=1+p*(J*W+K*X);Q<l&&(o=y,l=Q,s=q.candidate)}}else{for(var $=0;$<S;$++){var tt=k[$];tt.count=0,tt.candidate=m+g+$*g;for(var et=tt.bounds,nt=0;nt<3;nt++)et[nt]=1/0,et[nt+3]=-1/0}for(var rt=v;rt<h;rt+=6){var it=~~((n[rt+2*y]-m)/g);it>=S&&(it=31);var at=k[it];at.count++,M(rt,n,at.bounds)}var ot=k[31];T(ot.bounds,ot.rightCacheBounds);for(var st=30;st>=0;st--){var ut=k[st],ct=k[st+1];A(ut.bounds,ct.rightCacheBounds,ut.rightCacheBounds)}for(var dt=0,ft=0;ft<31;ft++){var lt=k[ft],vt=lt.count,ht=lt.bounds,pt=k[ft+1].rightCacheBounds;0!==vt&&(0===dt?T(ht,D):A(ht,D,D));var yt=0,mt=0;0!==(dt+=vt)&&(yt=I(D)/u);var gt=i-dt;0!==gt&&(mt=I(pt)/u);var xt=1+p*(yt*dt+mt*gt);xt<l&&(o=y,l=xt,s=lt.candidate)}}}else console.warn("MeshBVH: Invalid build strategy value ".concat(a," used."));return{axis:o,pos:s}}function z(t,e){function n(t){h&&h(t/p)}function r(e,i,a){var u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!y&&h>=d&&(y=!0,f&&(console.warn("MeshBVH: Max depth of ".concat(d," reached when generating BVH. Consider increasing maxDepth.")),console.warn(t))),a<=l||h>=d)return n(i+a),e.offset=i,e.count=a,e;var p=U(e.boundingData,u,s,i,a,v);if(-1===p.axis)return n(i+a),e.offset=i,e.count=a,e;var m=F(c,s,i,a,p);if(m===i||m===i+a)n(i+a),e.offset=i,e.count=a;else{e.splitAxis=p.axis;var g=new b,x=i,w=m-i;e.left=g,g.boundingData=new Float32Array(6),P(s,x,w,g.boundingData,o),r(g,x,w,o,h+1);var B=new b,T=m,A=a-w;e.right=B,B.boundingData=new Float32Array(6),P(s,T,A,B.boundingData,o),r(B,T,A,o,h+1)}return e}!function(t,e){if(!t.index){var n,r=t.attributes.position.count,i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;n=r>65535?new Uint32Array(new i(4*r)):new Uint16Array(new i(2*r)),t.setIndex(new u.BufferAttribute(n,1));for(var a=0;a<r;a++)n[a]=a}}(t,e);var a=new Float32Array(6),o=new Float32Array(6),s=function(t,e){var n=t.attributes.position,r=t.index.array,i=r.length/3,a=new Float32Array(6*i),o=n.normalized,s=n.array,u=n.offset||0,c=3;n.isInterleavedBufferAttribute&&(c=n.data.stride);for(var d=["getX","getY","getZ"],f=0;f<i;f++){var l=3*f,v=6*f,h=void 0,p=void 0,y=void 0;o?(h=r[l+0],p=r[l+1],y=r[l+2]):(h=r[l+0]*c+u,p=r[l+1]*c+u,y=r[l+2]*c+u);for(var m=0;m<3;m++){var x=void 0,b=void 0,w=void 0;o?(x=n[d[m]](h),b=n[d[m]](p),w=n[d[m]](y)):(x=s[h+m],b=s[p+m],w=s[y+m]);var B=x;b<B&&(B=b),w<B&&(B=w);var T=x;b>T&&(T=b),w>T&&(T=w);var A=(T-B)/2,M=2*m;a[v+M+0]=B+A,a[v+M+1]=A+(Math.abs(B)+A)*g,B<e[m]&&(e[m]=B),T>e[m+3]&&(e[m+3]=T)}}return a}(t,a),c=t.index.array,d=e.maxDepth,f=e.verbose,l=e.maxLeafTris,v=e.strategy,h=e.onProgress,p=t.index.count/3,y=!1,m=[],x=function(t){if(!t.groups||!t.groups.length)return[{offset:0,count:t.index.count/3}];var e,n=[],r=new Set,a=(0,i.Z)(t.groups);try{for(a.s();!(e=a.n()).done;){var o=e.value;r.add(o.start),r.add(o.start+o.count)}}catch(f){a.e(f)}finally{a.f()}for(var s=Array.from(r.values()).sort((function(t,e){return t-e})),u=0;u<s.length-1;u++){var c=s[u],d=s[u+1];n.push({offset:c/3,count:(d-c)/3})}return n}(t);if(1===x.length){var w=x[0],B=new b;B.boundingData=a,function(t,e,n,r){for(var i=1/0,a=1/0,o=1/0,s=-1/0,u=-1/0,c=-1/0,d=6*e,f=6*(e+n);d<f;d+=6){var l=t[d+0];l<i&&(i=l),l>s&&(s=l);var v=t[d+2];v<a&&(a=v),v>u&&(u=v);var h=t[d+4];h<o&&(o=h),h>c&&(c=h)}r[0]=i,r[1]=a,r[2]=o,r[3]=s,r[4]=u,r[5]=c}(s,w.offset,w.count,o),r(B,w.offset,w.count,o),m.push(B)}else{var T,A=(0,i.Z)(x);try{for(A.s();!(T=A.n()).done;){var M=T.value,I=new b;I.boundingData=new Float32Array(6),P(s,M.offset,M.count,I.boundingData,o),r(I,M.offset,M.count,o),m.push(I)}}catch(S){A.e(S)}finally{A.f()}}return m}function Z(t,e){for(var n,r,i,a=z(t,e),o=[],s=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,u=0;u<a.length;u++){var c=a[u],d=l(c),f=new s(y*d);n=new Float32Array(f),r=new Uint32Array(f),i=new Uint16Array(f),v(0,c),o.push(f)}return o;function l(t){return t.count?1:1+l(t.left)+l(t.right)}function v(t,e){for(var a=t/4,o=t/2,s=!!e.count,u=e.boundingData,c=0;c<6;c++)n[a+c]=u[c];if(s){var d=e.offset,f=e.count;return r[a+6]=d,i[o+14]=f,i[o+15]=m,t+y}var l,h=e.left,p=e.right,g=e.splitAxis;if((l=v(t+y,h))/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[a+6]=l/4,l=v(l,p),r[a+7]=g,l}}var E=n(64081),N=n(73246),_=n(58618),G=n(21324),R=function(){function t(){(0,o.Z)(this,t),this.min=1/0,this.max=-1/0}return(0,s.Z)(t,[{key:"setFromPointsField",value:function(t,e){for(var n=1/0,r=-1/0,i=0,a=t.length;i<a;i++){var o=t[i][e];n=o<n?o:n,r=o>r?o:r}this.min=n,this.max=r}},{key:"setFromPoints",value:function(t,e){for(var n=1/0,r=-1/0,i=0,a=e.length;i<a;i++){var o=e[i],s=t.dot(o);n=s<n?s:n,r=s>r?s:r}this.min=n,this.max=r}},{key:"isSeparated",value:function(t){return this.min>t.max||t.min>this.max}}]),t}();R.prototype.setFromBox=function(){var t=new u.Vector3;return function(e,n){for(var r=n.min,i=n.max,a=1/0,o=-1/0,s=0;s<=1;s++)for(var u=0;u<=1;u++)for(var c=0;c<=1;c++){t.x=r.x*s+i.x*(1-s),t.y=r.y*u+i.y*(1-u),t.z=r.z*c+i.z*(1-c);var d=e.dot(t);a=Math.min(d,a),o=Math.max(d,o)}this.min=a,this.max=o}}();!function(){var t=new R}();var C=function(){var t=new u.Vector3,e=new u.Vector3,n=new u.Vector3;return function(r,i,a){var o=r.start,s=t,u=i.start,c=e;n.subVectors(o,u),t.subVectors(r.end,r.start),e.subVectors(i.end,i.start);var d,f,l=n.dot(c),v=c.dot(s),h=c.dot(c),p=n.dot(s),y=s.dot(s)*h-v*v;f=(l+(d=0!==y?(l*v-p*h)/y:0)*v)/h,a.x=d,a.y=f}}(),O=function(){var t=new u.Vector2,e=new u.Vector3,n=new u.Vector3;return function(r,i,a,o){C(r,i,t);var s,u,c=t.x,d=t.y;if(c>=0&&c<=1&&d>=0&&d<=1)return r.at(c,a),void i.at(d,o);if(c>=0&&c<=1)return d<0?i.at(0,o):i.at(1,o),void r.closestPointToPoint(o,!0,a);if(d>=0&&d<=1)return c<0?r.at(0,a):r.at(1,a),void i.closestPointToPoint(a,!0,o);s=c<0?r.start:r.end,u=d<0?i.start:i.end;var f=e,l=n;return r.closestPointToPoint(u,!0,e),i.closestPointToPoint(s,!0,n),f.distanceToSquared(u)<=l.distanceToSquared(s)?(a.copy(f),void o.copy(u)):(a.copy(s),void o.copy(l))}}(),H=function(){var t=new u.Vector3,e=new u.Vector3,n=new u.Plane,r=new u.Line3;return function(i,a){var o=i.radius,s=i.center,u=a.a,c=a.b,d=a.c;if(r.start=u,r.end=c,r.closestPointToPoint(s,!0,t).distanceTo(s)<=o)return!0;if(r.start=u,r.end=d,r.closestPointToPoint(s,!0,t).distanceTo(s)<=o)return!0;if(r.start=c,r.end=d,r.closestPointToPoint(s,!0,t).distanceTo(s)<=o)return!0;var f=a.getPlane(n);if(Math.abs(f.distanceToPoint(s))<=o){var l=f.projectPoint(s,e);if(a.containsPoint(l))return!0}return!1}}();function L(t){return Math.abs(t)<1e-15}var q=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(){var t;(0,o.Z)(this,n);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(t=e.call.apply(e,[this].concat(i))).isExtendedTriangle=!0,t.satAxes=new Array(4).fill().map((function(){return new u.Vector3})),t.satBounds=new Array(4).fill().map((function(){return new R})),t.points=[t.a,t.b,t.c],t.sphere=new u.Sphere,t.plane=new u.Plane,t.needsUpdate=!0,t}return(0,s.Z)(n,[{key:"intersectsSphere",value:function(t){return H(t,this)}},{key:"update",value:function(){var t=this.a,e=this.b,n=this.c,r=this.points,i=this.satAxes,a=this.satBounds,o=i[0],s=a[0];this.getNormal(o),s.setFromPoints(o,r);var u=i[1],c=a[1];u.subVectors(t,e),c.setFromPoints(u,r);var d=i[2],f=a[2];d.subVectors(e,n),f.setFromPoints(d,r);var l=i[3],v=a[3];l.subVectors(n,t),v.setFromPoints(l,r),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,t),this.needsUpdate=!1}}]),n}(u.Triangle);q.prototype.closestPointToSegment=function(){var t=new u.Vector3,e=new u.Vector3,n=new u.Line3;return function(r){for(var i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=r.start,u=r.end,c=this.points,d=1/0,f=0;f<3;f++){var l=(f+1)%3;n.start.copy(c[f]),n.end.copy(c[l]),O(n,r,t,e),(i=t.distanceToSquared(e))<d&&(d=i,a&&a.copy(t),o&&o.copy(e))}return this.closestPointToPoint(s,t),(i=s.distanceToSquared(t))<d&&(d=i,a&&a.copy(t),o&&o.copy(s)),this.closestPointToPoint(u,t),(i=u.distanceToSquared(t))<d&&(d=i,a&&a.copy(t),o&&o.copy(u)),Math.sqrt(d)}}(),q.prototype.intersectsTriangle=function(){var t=new q,e=new Array(3),n=new Array(3),r=new R,i=new R,a=new u.Vector3,o=new u.Vector3,s=new u.Vector3,c=new u.Vector3,d=new u.Line3,f=new u.Line3,l=new u.Line3;return function(u){var v=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.needsUpdate&&this.update(),u.isExtendedTriangle?u.needsUpdate&&u.update():(t.copy(u),t.update(),u=t);var h=this.plane,p=u.plane;if(Math.abs(h.normal.dot(p.normal))>1-1e-10){var y=this.satBounds,m=this.satAxes;n[0]=u.a,n[1]=u.b,n[2]=u.c;for(var g=0;g<4;g++){var x=y[g],b=m[g];if(r.setFromPoints(b,n),x.isSeparated(r))return!1}var w=u.satBounds,B=u.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(var T=0;T<4;T++){var A=w[T],M=B[T];if(r.setFromPoints(M,e),A.isSeparated(r))return!1}for(var I=0;I<4;I++)for(var P=m[I],F=0;F<4;F++){var S=B[F];if(a.crossVectors(P,S),r.setFromPoints(a,e),i.setFromPoints(a,n),r.isSeparated(i))return!1}return v&&(console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),v.start.set(0,0,0),v.end.set(0,0,0)),!0}for(var V=this.points,k=!1,D=0,U=0;U<3;U++){var z=V[U],Z=V[(U+1)%3];d.start.copy(z),d.end.copy(Z),d.delta(o);var E=k?f.start:f.end,N=L(p.distanceToPoint(z));if(L(p.normal.dot(o))&&N){f.copy(d),D=2;break}var _=p.intersectLine(d,E)||N;if(_&&!L(E.distanceTo(Z))){if(D++,k)break;k=!0}}if(1===D&&this.containsPoint(f.end))return v&&(v.start.copy(f.end),v.end.copy(f.end)),!0;if(2!==D)return!1;for(var G=u.points,R=!1,C=0,O=0;O<3;O++){var H=G[O],q=G[(O+1)%3];d.start.copy(H),d.end.copy(q),d.delta(s);var W=R?l.start:l.end,X=L(h.distanceToPoint(H));if(L(h.normal.dot(s))&&X){l.copy(d),C=2;break}var Y=h.intersectLine(d,W)||X;if(Y&&!L(W.distanceTo(q))){if(C++,R)break;R=!0}}if(1===C&&this.containsPoint(l.end))return v&&(v.start.copy(l.end),v.end.copy(l.end)),!0;if(2!==C)return!1;if(f.delta(o),l.delta(s),o.dot(s)<0){var j=l.start;l.start=l.end,l.end=j}var J=f.start.dot(o),K=f.end.dot(o),Q=l.start.dot(o),$=l.end.dot(o),tt=K<Q,et=J<$;return(J===$||Q===K||tt!==et)&&(v&&(c.subVectors(f.start,l.start),c.dot(o)>0?v.start.copy(f.start):v.start.copy(l.start),c.subVectors(f.end,l.end),c.dot(o)<0?v.end.copy(f.end):v.end.copy(l.end)),!0)}}(),q.prototype.distanceToPoint=function(){var t=new u.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),q.prototype.distanceToTriangle=function(){var t=new u.Vector3,e=new u.Vector3,n=["a","b","c"],r=new u.Line3,i=new u.Line3;return function(a){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,u=o||s?r:null;if(this.intersectsTriangle(a,u))return(o||s)&&(o&&u.getCenter(o),s&&u.getCenter(s)),0;for(var c=1/0,d=0;d<3;d++){var f=void 0,l=n[d],v=a[l];this.closestPointToPoint(v,t),(f=v.distanceToSquared(t))<c&&(c=f,o&&o.copy(t),s&&s.copy(v));var h=this[l];a.closestPointToPoint(h,t),(f=h.distanceToSquared(t))<c&&(c=f,o&&o.copy(h),s&&s.copy(t))}for(var p=0;p<3;p++){var y=n[p],m=n[(p+1)%3];r.set(this[y],this[m]);for(var g=0;g<3;g++){var x=n[g],b=n[(g+1)%3];i.set(a[x],a[b]),O(r,i,t,e);var w=t.distanceToSquared(e);w<c&&(c=w,o&&o.copy(t),s&&s.copy(e))}}return Math.sqrt(c)}}();var W=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(){var t;(0,o.Z)(this,n);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(t=e.call.apply(e,[this].concat(i))).isOrientedBox=!0,t.matrix=new u.Matrix4,t.invMatrix=new u.Matrix4,t.points=new Array(8).fill().map((function(){return new u.Vector3})),t.satAxes=new Array(3).fill().map((function(){return new u.Vector3})),t.satBounds=new Array(3).fill().map((function(){return new R})),t.alignedSatBounds=new Array(3).fill().map((function(){return new R})),t.needsUpdate=!1,t}return(0,s.Z)(n,[{key:"set",value:function(t,e,r){(0,E.Z)((0,N.Z)(n.prototype),"set",this).call(this,t,e),this.matrix.copy(r),this.needsUpdate=!0}},{key:"copy",value:function(t){(0,E.Z)((0,N.Z)(n.prototype),"copy",this).call(this,t),this.matrix.copy(t.matrix),this.needsUpdate=!0}}]),n}(u.Box3);W.prototype.update=function(){for(var t=this.matrix,e=this.min,n=this.max,r=this.points,i=0;i<=1;i++)for(var a=0;a<=1;a++)for(var o=0;o<=1;o++){var s=r[1*i|2*a|4*o];s.x=i?n.x:e.x,s.y=a?n.y:e.y,s.z=o?n.z:e.z,s.applyMatrix4(t)}for(var u=this.satBounds,c=this.satAxes,d=r[0],f=0;f<3;f++){var l=c[f],v=u[f],h=r[1<<f];l.subVectors(d,h),v.setFromPoints(l,r)}var p=this.alignedSatBounds;p[0].setFromPointsField(r,"x"),p[1].setFromPointsField(r,"y"),p[2].setFromPointsField(r,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},W.prototype.intersectsBox=function(){var t=new R;return function(e){this.needsUpdate&&this.update();var n=e.min,r=e.max,i=this.satBounds,a=this.satAxes,o=this.alignedSatBounds;if(t.min=n.x,t.max=r.x,o[0].isSeparated(t))return!1;if(t.min=n.y,t.max=r.y,o[1].isSeparated(t))return!1;if(t.min=n.z,t.max=r.z,o[2].isSeparated(t))return!1;for(var s=0;s<3;s++){var u=a[s],c=i[s];if(t.setFromBox(u,e),c.isSeparated(t))return!1}return!0}}(),W.prototype.intersectsTriangle=function(){var t=new q,e=new Array(3),n=new R,r=new R,i=new u.Vector3;return function(a){this.needsUpdate&&this.update(),a.isExtendedTriangle?a.needsUpdate&&a.update():(t.copy(a),t.update(),a=t);var o=this.satBounds,s=this.satAxes;e[0]=a.a,e[1]=a.b,e[2]=a.c;for(var u=0;u<3;u++){var c=o[u],d=s[u];if(n.setFromPoints(d,e),c.isSeparated(n))return!1}for(var f=a.satBounds,l=a.satAxes,v=this.points,h=0;h<3;h++){var p=f[h],y=l[h];if(n.setFromPoints(y,v),p.isSeparated(n))return!1}for(var m=0;m<3;m++)for(var g=s[m],x=0;x<4;x++){var b=l[x];if(i.crossVectors(g,b),n.setFromPoints(i,e),r.setFromPoints(i,v),n.isSeparated(r))return!1}return!0}}(),W.prototype.closestPointToPoint=function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e},W.prototype.distanceToPoint=function(){var t=new u.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),W.prototype.distanceToBox=function(){var t=["x","y","z"],e=new Array(12).fill().map((function(){return new u.Line3})),n=new Array(12).fill().map((function(){return new u.Line3})),r=new u.Vector3,i=new u.Vector3;return function(a){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.needsUpdate&&this.update(),this.intersectsBox(a))return(s||u)&&(a.getCenter(i),this.closestPointToPoint(i,r),a.closestPointToPoint(r,i),s&&s.copy(r),u&&u.copy(i)),0;for(var c=o*o,d=a.min,f=a.max,l=this.points,v=1/0,h=0;h<8;h++){var p=l[h];i.copy(p).clamp(d,f);var y=p.distanceToSquared(i);if(y<v&&(v=y,s&&s.copy(p),u&&u.copy(i),y<c))return Math.sqrt(y)}for(var m=0,g=0;g<3;g++)for(var x=0;x<=1;x++)for(var b=0;b<=1;b++){var w=(g+1)%3,B=(g+2)%3,T=x<<w|b<<B,A=1<<g|x<<w|b<<B,M=l[T],I=l[A],P=e[m];P.set(M,I);var F=t[g],S=t[w],V=t[B],k=n[m],D=k.start,U=k.end;D[F]=d[F],D[S]=x?d[S]:f[S],D[V]=b?d[V]:f[S],U[F]=f[F],U[S]=x?d[S]:f[S],U[V]=b?d[V]:f[S],m++}for(var z=0;z<=1;z++)for(var Z=0;Z<=1;Z++)for(var E=0;E<=1;E++){i.x=z?f.x:d.x,i.y=Z?f.y:d.y,i.z=E?f.z:d.z,this.closestPointToPoint(i,r);var N=i.distanceToSquared(r);if(N<v&&(v=N,s&&s.copy(r),u&&u.copy(i),N<c))return Math.sqrt(N)}for(var _=0;_<12;_++)for(var G=e[_],R=0;R<12;R++){var C=n[R];O(G,C,r,i);var H=r.distanceToSquared(i);if(H<v&&(v=H,s&&s.copy(r),u&&u.copy(i),H<c))return Math.sqrt(H)}return Math.sqrt(v)}}();var X=new u.Vector3,Y=new u.Vector3,j=new u.Vector3,J=new u.Vector2,K=new u.Vector2,Q=new u.Vector2,$=new u.Vector3;function tt(t,e,n,r,i,a,o){X.fromBufferAttribute(e,r),Y.fromBufferAttribute(e,i),j.fromBufferAttribute(e,a);var s=function(t,e,n,r,i,a){return null===(a===u.BackSide?t.intersectTriangle(r,n,e,!0,i):t.intersectTriangle(e,n,r,a!==u.DoubleSide,i))?null:{distance:t.origin.distanceTo(i),point:i.clone()}}(t,X,Y,j,$,o);if(s){n&&(J.fromBufferAttribute(n,r),K.fromBufferAttribute(n,i),Q.fromBufferAttribute(n,a),s.uv=u.Triangle.getUV($,X,Y,j,J,K,Q,new u.Vector2));var c={a:r,b:i,c:a,normal:new u.Vector3,materialIndex:0};u.Triangle.getNormal(X,Y,j,c.normal),s.face=c,s.faceIndex=r}return s}function et(t,e,n,r,i){var a=3*r,o=t.index.getX(a),s=t.index.getX(a+1),u=t.index.getX(a+2),c=tt(n,t.attributes.position,t.attributes.uv,o,s,u,e);return c?(c.faceIndex=r,i&&i.push(c),c):null}function nt(t,e,n){return null===t?null:(t.point.applyMatrix4(e.matrixWorld),t.distance=t.point.distanceTo(n.ray.origin),t.object=e,t.distance<n.near||t.distance>n.far?null:t)}function rt(t,e,n,r){var i=t.a,a=t.b,o=t.c,s=e,u=e+1,c=e+2;n&&(s=n.getX(e),u=n.getX(e+1),c=n.getX(e+2)),i.x=r.getX(s),i.y=r.getY(s),i.z=r.getZ(s),a.x=r.getX(u),a.y=r.getY(u),a.z=r.getZ(u),o.x=r.getX(c),o.y=r.getY(c),o.z=r.getZ(c)}function it(t,e,n,r,i,a,o){for(var s=n.index,u=n.attributes.position,c=t,d=e+t;c<d;c++)if(rt(o,3*c,s,u),o.needsUpdate=!0,r(o,c,i,a))return!0;return!1}var at=new u.Vector3,ot=new u.Vector3,st=new u.Vector3,ut=new u.Vector2,ct=new u.Vector2,dt=new u.Vector2;function ft(t,e,n,r){var i=e.getIndex().array,a=e.getAttribute("position"),o=e.getAttribute("uv"),s=i[3*n],c=i[3*n+1],d=i[3*n+2];at.fromBufferAttribute(a,s),ot.fromBufferAttribute(a,c),st.fromBufferAttribute(a,d);for(var f=0,l=e.groups,v=3*n,h=0,p=l.length;h<p;h++){var y=l[h],m=y.start,g=y.count;if(v>=m&&v<m+g){f=y.materialIndex;break}}var x=null;return o&&(ut.fromBufferAttribute(o,s),ct.fromBufferAttribute(o,c),dt.fromBufferAttribute(o,d),x=r&&r.uv?r.uv:new u.Vector2,u.Triangle.getUV(t,at,ot,st,ut,ct,dt,x)),r?(r.face||(r.face={}),r.face.a=s,r.face.b=c,r.face.c=d,r.face.materialIndex=f,r.face.normal||(r.face.normal=new u.Vector3),u.Triangle.getNormal(at,ot,st,r.face.normal),r.uv||(r.uv=new u.Vector2),r.uv.copy(x),r):{face:{a:s,b:c,c:d,materialIndex:f,normal:u.Triangle.getNormal(at,ot,st,new u.Vector3)},uv:x}}var lt=function(){function t(e){(0,o.Z)(this,t),this._getNewPrimitive=e,this._primitives=[]}return(0,s.Z)(t,[{key:"getPrimitive",value:function(){var t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}},{key:"releasePrimitive",value:function(t){this._primitives.push(t)}}]),t}();function vt(t,e){return 65535===e[t+15]}function ht(t,e){return e[t+6]}function pt(t,e){return e[t+14]}function yt(t){return t+8}function mt(t,e){return e[t+6]}function gt(t,e){return e[t+7]}var xt=new u.Box3,bt=new u.Vector3,wt=["x","y","z"];function Bt(t,e,n,r,i){var a=2*t,o=Ft,s=St,u=Vt;if(vt(a,s)){!function(t,e,n,r,i,a){for(var o=r,s=r+i;o<s;o++)et(t,e,n,o,a)}(e,n,r,ht(t,u),pt(a,s),i)}else{var c=yt(t);It(c,o,r,bt)&&Bt(c,e,n,r,i);var d=mt(t,u);It(d,o,r,bt)&&Bt(d,e,n,r,i)}}function Tt(t,e,n,r){var i=2*t,a=Ft,o=St,s=Vt;if(vt(i,o))return function(t,e,n,r,i){for(var a=1/0,o=null,s=r,u=r+i;s<u;s++){var c=et(t,e,n,s);c&&c.distance<a&&(o=c,a=c.distance)}return o}(e,n,r,ht(t,s),pt(i,o));var u,c,d=gt(t,s),f=wt[d],l=r.direction[f]>=0;l?(u=yt(t),c=mt(t,s)):(u=mt(t,s),c=yt(t));var v=It(u,a,r,bt)?Tt(u,e,n,r):null;if(v){var h=v.point[f];if(l?h<=a[c+d]:h>=a[c+d+3])return v}var p=It(c,a,r,bt)?Tt(c,e,n,r):null;return v&&p?v.distance<=p.distance?v:p:v||p||null}var At=function(){var t,e,n=[],r=new lt((function(){return new u.Box3}));return function(){t=r.getPrimitive(),e=r.getPrimitive(),n.push(t,e);var a=i.apply(void 0,arguments);r.releasePrimitive(t),r.releasePrimitive(e),n.pop(),n.pop();var o=n.length;return o>0&&(e=n[o-1],t=n[o-2]),a};function i(n,r,a,o){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;function d(t){for(var e=2*t,n=St,r=Vt;!vt(e,n);)e=2*(t=yt(t));return ht(t,r)}function f(t){for(var e=2*t,n=St,r=Vt;!vt(e,n);)e=2*(t=mt(t,r));return ht(t,r)+pt(e,n)}var l=2*n,v=Ft,p=St,y=Vt,m=vt(l,p);if(m){var g=ht(n,y),x=pt(l,p);return w(n,v,t),o(g,x,!1,c,u+n,t)}var b,B,T,A,M=yt(n),I=mt(n,y),P=M,F=I;if(s&&(A=e,w(P,v,T=t),w(F,v,A),b=s(T),(B=s(A))<b)){P=I,F=M;var S=b;b=B,B=S,T=A}T||w(P,v,T=t);var V,k=vt(2*P,p),D=a(T,k,b,c+1,u+P);if(D===h){var U=d(P),z=f(P),Z=z-U;V=o(U,Z,!0,c+1,u+P,T)}else V=D&&i(P,r,a,o,s,u,c+1);if(V)return!0;w(F,v,A=e);var E,N=vt(2*F,p),_=a(A,N,B,c+1,u+F);if(_===h){var G=d(F),R=f(F),C=R-G;E=o(G,C,!0,c+1,u+F,A)}else E=_&&i(F,r,a,o,s,u,c+1);return!!E}}(),Mt=function(){var t=new q,e=new q,n=new u.Matrix4,r=new W,i=new W;return function a(o,s,u,c){var d=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,f=2*o,l=Ft,v=St,h=Vt;null===d&&(u.boundingBox||u.computeBoundingBox(),r.set(u.boundingBox.min,u.boundingBox.max,c),d=r);var p=vt(f,v);if(!p){var y=o+8,m=h[o+6];w(y,l,xt);var g=d.intersectsBox(xt)&&a(y,s,u,c,d);if(g)return!0;w(m,l,xt);var x=d.intersectsBox(xt)&&a(m,s,u,c,d);return!!x}var b=s,B=b.index,T=b.attributes.position,A=u.index,M=u.attributes.position,I=ht(o,h),P=pt(f,v);if(n.copy(c).invert(),u.boundsTree){w(o,l,i),i.matrix.copy(n),i.needsUpdate=!0;var F=u.boundsTree.shapecast({intersectsBounds:function(t){return i.intersectsBox(t)},intersectsTriangle:function(t){t.a.applyMatrix4(c),t.b.applyMatrix4(c),t.c.applyMatrix4(c),t.needsUpdate=!0;for(var n=3*I,r=3*(P+I);n<r;n+=3)if(rt(e,n,B,T),e.needsUpdate=!0,t.intersectsTriangle(e))return!0;return!1}});return F}for(var S=3*I,V=P+3*I;S<V;S+=3){rt(t,S,B,T),t.a.applyMatrix4(n),t.b.applyMatrix4(n),t.c.applyMatrix4(n),t.needsUpdate=!0;for(var k=0,D=A.count;k<D;k+=3)if(rt(e,k,A,M),e.needsUpdate=!0,t.intersectsTriangle(e))return!0}}}();function It(t,e,n,r){return w(t,e,xt),n.intersectBox(xt,r)}var Pt,Ft,St,Vt,kt=[];function Dt(t){Pt&&kt.push(Pt),Pt=t,Ft=new Float32Array(t),St=new Uint16Array(t),Vt=new Uint32Array(t)}function Ut(){Pt=null,Ft=null,St=null,Vt=null,kt.length&&Dt(kt.pop())}var zt=Symbol("skip tree generation"),Zt=new u.Box3,Et=new u.Box3,Nt=new u.Matrix4,_t=new W,Gt=new W,Rt=new u.Vector3,Ct=new u.Vector3,Ot=new u.Vector3,Ht=new u.Vector3,Lt=new u.Vector3,qt=new u.Box3,Wt=new lt((function(){return new q})),Xt=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((0,o.Z)(this,t),!e.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((n=Object.assign((0,a.Z)({strategy:c,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null},zt,!1),n)).useSharedArrayBuffer&&"undefined"===typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this._roots=null,n[zt]||(this._roots=Z(e,n),!e.boundingBox&&n.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new u.Box3))),this.geometry=e}return(0,s.Z)(t,[{key:"refit",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t&&Array.isArray(t)&&(t=new Set(t));for(var e,n,r,i,a=this.geometry,o=a.index.array,s=a.attributes.position,u=0,c=this._roots,d=0,f=c.length;d<f;d++)e=c[d],n=new Uint32Array(e),r=new Uint16Array(e),i=new Float32Array(e),l(0,u),u+=e.byteLength;function l(e,a){var u=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=2*e,d=r[c+15]===m;if(d){for(var f=n[e+6],v=r[c+14],h=1/0,p=1/0,y=1/0,g=-1/0,x=-1/0,b=-1/0,w=3*f,B=3*(f+v);w<B;w++){var T=o[w],A=s.getX(T),M=s.getY(T),I=s.getZ(T);A<h&&(h=A),A>g&&(g=A),M<p&&(p=M),M>x&&(x=M),I<y&&(y=I),I>b&&(b=I)}return(i[e+0]!==h||i[e+1]!==p||i[e+2]!==y||i[e+3]!==g||i[e+4]!==x||i[e+5]!==b)&&(i[e+0]=h,i[e+1]=p,i[e+2]=y,i[e+3]=g,i[e+4]=x,i[e+5]=b,!0)}var P=e+8,F=n[e+6],S=P+a,V=F+a,k=u,D=!1,U=!1;t?k||(D=t.has(S),U=t.has(V),k=!D&&!U):(D=!0,U=!0);var z=k||D,Z=k||U,E=!1;z&&(E=l(P,a,k));var N=!1;Z&&(N=l(F,a,k));var _=E||N;if(_)for(var G=0;G<3;G++){var R=P+G,C=F+G,O=i[R],H=i[R+3],L=i[C],q=i[C+3];i[e+G]=O<L?O:L,i[e+G+3]=H>q?H:q}return _}}},{key:"traverse",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._roots[e],r=new Uint32Array(n),i=new Uint16Array(n);function a(e){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=2*e,u=i[s+15]===m;if(u){var c=r[e+6],d=i[s+14];t(o,u,new Float32Array(n,4*e,6),c,d)}else{var f=e+8,l=r[e+6],v=r[e+7],h=t(o,u,new Float32Array(n,4*e,6),v);h||(a(f,o+1),a(l,o+1))}}a(0)}},{key:"raycast",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u.FrontSide,n=this._roots,r=this.geometry,i=[],a=e.isMaterial,o=Array.isArray(e),s=r.groups,c=a?e.side:e,d=0,f=n.length;d<f;d++){var l=o?e[s[d].materialIndex].side:c,v=i.length;if(Dt(n[d]),Bt(0,r,l,t,i),Ut(),o)for(var h=s[d].materialIndex,p=v,y=i.length;p<y;p++)i[p].face.materialIndex=h}return i}},{key:"raycastFirst",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u.FrontSide,n=this._roots,r=this.geometry,i=e.isMaterial,a=Array.isArray(e),o=null,s=r.groups,c=i?e.side:e,d=0,f=n.length;d<f;d++){var l=a?e[s[d].materialIndex].side:c;Dt(n[d]);var v=Tt(0,r,l,t);Ut(),null!=v&&(null==o||v.distance<o.distance)&&(o=v,a&&(v.face.materialIndex=s[d].materialIndex))}return o}},{key:"intersectsGeometry",value:function(t,e){var n,r=this.geometry,a=!1,o=(0,i.Z)(this._roots);try{for(o.s();!(n=o.n()).done;){if(Dt(n.value),a=Mt(0,r,t,e),Ut(),a)break}}catch(s){o.e(s)}finally{o.f()}return a}},{key:"shapecast",value:function(t,e,n){var r=this.geometry;if(t instanceof Function){if(e){var a=e;e=function(t,e,n,r){var i=3*e;return a(t,i,i+1,i+2,n,r)}}t={boundsTraverseOrder:n,intersectsBounds:t,intersectsTriangle:e,intersectsRange:null},console.warn("MeshBVH: Shapecast function signature has changed and now takes an object of callbacks as a second argument. See docs for new signature.")}var o=Wt.getPrimitive(),s=t,u=s.boundsTraverseOrder,c=s.intersectsBounds,d=s.intersectsRange,f=s.intersectsTriangle;if(d&&f){var l=d;d=function(t,e,n,i,a){return!!l(t,e,n,i,a)||it(t,e,r,f,n,i,o)}}else d||(d=f?function(t,e,n,i){return it(t,e,r,f,n,i,o)}:function(t,e,n){return n});var v,h=!1,p=0,y=(0,i.Z)(this._roots);try{for(y.s();!(v=y.n()).done;){var m=v.value;if(Dt(m),h=At(0,r,c,d,u,p),Ut(),h)break;p+=m.byteLength}}catch(g){y.e(g)}finally{y.f()}return Wt.releasePrimitive(o),h}},{key:"bvhcast",value:function(t,e,n){var r=n.intersectsRanges,i=n.intersectsTriangles,a=this.geometry.index,o=this.geometry.attributes.position,s=t.geometry.index,u=t.geometry.attributes.position;Nt.copy(e).invert();var c=Wt.getPrimitive(),d=Wt.getPrimitive();if(i){var f=function(t,n,r,f,l,v,h,p){for(var y=r,m=r+f;y<m;y++){rt(d,3*y,s,u),d.a.applyMatrix4(e),d.b.applyMatrix4(e),d.c.applyMatrix4(e),d.needsUpdate=!0;for(var g=t,x=t+n;g<x;g++)if(rt(c,3*g,a,o),c.needsUpdate=!0,i(c,d,g,y,l,v,h,p))return!0}return!1};if(r){var l=r;r=function(t,e,n,r,i,a,o,s){return!!l(t,e,n,r,i,a,o,s)||f(t,e,n,r,i,a,o,s)}}else r=f}t.getBoundingBox(Et),Et.applyMatrix4(e);var v=this.shapecast({intersectsBounds:function(t){return Et.intersectsBox(t)},intersectsRange:function(e,n,i,a,o,s){return Zt.copy(s),Zt.applyMatrix4(Nt),t.shapecast({intersectsBounds:function(t){return Zt.intersectsBox(t)},intersectsRange:function(t,i,s,u,c){return r(e,n,t,i,a,o,u,c)}})}});return Wt.releasePrimitive(c),Wt.releasePrimitive(d),v}},{key:"intersectsBox",value:function(t,e){return _t.set(t.min,t.max,e),_t.needsUpdate=!0,this.shapecast({intersectsBounds:function(t){return _t.intersectsBox(t)},intersectsTriangle:function(t){return _t.intersectsTriangle(t)}})}},{key:"intersectsSphere",value:function(t){return this.shapecast({intersectsBounds:function(e){return t.intersectsBox(e)},intersectsTriangle:function(e){return e.intersectsSphere(t)}})}},{key:"closestPointToGeometry",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1/0;t.boundingBox||t.computeBoundingBox(),_t.set(t.boundingBox.min,t.boundingBox.max,e),_t.needsUpdate=!0;var o=this.geometry,s=o.attributes.position,u=o.index,c=t.attributes.position,d=t.index,f=Wt.getPrimitive(),l=Wt.getPrimitive(),v=Ct,h=Ot,p=null,y=null;r&&(p=Ht,y=Lt);var m=1/0,g=null,x=null;return Nt.copy(e).invert(),Gt.matrix.copy(Nt),this.shapecast({boundsTraverseOrder:function(t){return _t.distanceToBox(t)},intersectsBounds:function(t,e,n){return n<m&&n<a&&(e&&(Gt.min.copy(t.min),Gt.max.copy(t.max),Gt.needsUpdate=!0),!0)},intersectsRange:function(n,r){if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:function(t){return Gt.distanceToBox(t)},intersectsBounds:function(t,e,n){return n<m&&n<a},intersectsRange:function(t,a){for(var o=3*t,b=3*(t+a);o<b;o+=3){rt(l,o,d,c),l.a.applyMatrix4(e),l.b.applyMatrix4(e),l.c.applyMatrix4(e),l.needsUpdate=!0;for(var w=3*n,B=3*(n+r);w<B;w+=3){rt(f,w,u,s),f.needsUpdate=!0;var T=f.distanceToTriangle(l,v,p);if(T<m&&(h.copy(v),y&&y.copy(p),m=T,g=w/3,x=o/3),T<i)return!0}}}});for(var o=0,b=d?d.count:c.count;o<b;o+=3){rt(l,o,d,c),l.a.applyMatrix4(e),l.b.applyMatrix4(e),l.c.applyMatrix4(e),l.needsUpdate=!0;for(var w=3*n,B=3*(n+r);w<B;w+=3){rt(f,w,u,s),f.needsUpdate=!0;var T=f.distanceToTriangle(l,v,p);if(T<m&&(h.copy(v),y&&y.copy(p),m=T,g=w/3,x=o/3),T<i)return!0}}}}),Wt.releasePrimitive(f),Wt.releasePrimitive(l),m===1/0?null:(n.point?n.point.copy(h):n.point=h.clone(),n.distance=m,n.faceIndex=g,r&&(r.point?r.point.copy(y):r.point=y.clone(),r.point.applyMatrix4(Nt),h.applyMatrix4(Nt),r.distance=h.sub(r.point).length(),r.faceIndex=x),n)}},{key:"closestPointToPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,i=n*n,a=r*r,o=1/0,s=null;if(this.shapecast({boundsTraverseOrder:function(e){return Rt.copy(t).clamp(e.min,e.max),Rt.distanceToSquared(t)},intersectsBounds:function(t,e,n){return n<o&&n<a},intersectsTriangle:function(e,n){e.closestPointToPoint(t,Rt);var r=t.distanceToSquared(Rt);return r<o&&(Ct.copy(Rt),o=r,s=n),r<i}}),o===1/0)return null;var u=Math.sqrt(o);return e.point?e.point.copy(Ct):e.point=Ct.clone(),e.distance=u,e.faceIndex=s,e}},{key:"getBoundingBox",value:function(t){return t.makeEmpty(),this._roots.forEach((function(e){w(0,new Float32Array(e),qt),t.union(qt)})),t}}],[{key:"serialize",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(n.isBufferGeometry)return console.warn("MeshBVH.serialize: The arguments for the function have changed. See documentation for new signature."),t.serialize(arguments[0],{cloneBuffers:void 0===arguments[2]||arguments[2]});n=(0,r.Z)({cloneBuffers:!0},n);var i=e.geometry,a=e._roots,o=i.getIndex();return n.cloneBuffers?{roots:a.map((function(t){return t.slice()})),index:o.array.slice()}:{roots:a,index:o.array}}},{key:"deserialize",value:function(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("boolean"===typeof i)return console.warn("MeshBVH.deserialize: The arguments for the function have changed. See documentation for new signature."),t.deserialize(arguments[0],arguments[1],{setIndex:void 0===arguments[2]||arguments[2]});i=(0,r.Z)({setIndex:!0},i);var o=e.index,s=e.roots,c=new t(n,(0,r.Z)((0,r.Z)({},i),{},(0,a.Z)({},zt,!0)));if(c._roots=s,i.setIndex){var d=n.getIndex();if(null===d){var f=new u.BufferAttribute(e.index,1,!1);n.setIndex(f)}else d.array!==o&&(d.array.set(o),d.needsUpdate=!0)}return c}}]),t}(),Yt=new u.Box3,jt=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(t,r){var i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return(0,o.Z)(this,n),(i=e.call(this)).material=r,i.geometry=new u.BufferGeometry,i.name="MeshBVHRootVisualizer",i.depth=a,i.displayParents=!1,i.mesh=t,i.displayEdges=!0,i._group=s,i}return(0,s.Z)(n,[{key:"isMesh",get:function(){return!this.displayEdges}},{key:"isLineSegments",get:function(){return this.displayEdges}},{key:"isLine",get:function(){return this.displayEdges}},{key:"raycast",value:function(){}},{key:"update",value:function(){var t=this.geometry,e=this.mesh.geometry.boundsTree,n=this._group;if(t.dispose(),this.visible=!1,e){var r=this.depth-1,i=this.displayParents,a=0;e.traverse((function(t,e){if(t===r||e)return a++,!0;i&&a++}),n);var o,s,c=0,d=new Float32Array(24*a);e.traverse((function(t,e,n){var a=t===r||e;if(a||i){w(0,n,Yt);for(var o=Yt.min,s=Yt.max,u=-1;u<=1;u+=2)for(var f=u<0?o.x:s.x,l=-1;l<=1;l+=2)for(var v=l<0?o.y:s.y,h=-1;h<=1;h+=2){var p=h<0?o.z:s.z;d[c+0]=f,d[c+1]=v,d[c+2]=p,c+=3}return a}}),n),s=this.displayEdges?new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),o=d.length>65535?new Uint32Array(s.length*a):new Uint16Array(s.length*a);for(var f=s.length,l=0;l<a;l++)for(var v=8*l,h=l*f,p=0;p<f;p++)o[h+p]=v+s[p];t.setIndex(new u.BufferAttribute(o,1,!1)),t.setAttribute("position",new u.BufferAttribute(d,3,!1)),this.visible=!0}}}]),n}(u.Object3D),Jt=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(t){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;(0,o.Z)(this,n),(r=e.call(this)).name="MeshBVHVisualizer",r.depth=i,r.mesh=t,r.displayParents=!1,r.displayEdges=!0,r._roots=[];var a=new u.LineBasicMaterial({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),s=new u.MeshBasicMaterial({color:65416,transparent:!0,opacity:.3,depthWrite:!1});return s.color=a.color,r.edgeMaterial=a,r.meshMaterial=s,r.update(),r}return(0,s.Z)(n,[{key:"color",get:function(){return this.edgeMaterial.color}},{key:"opacity",get:function(){return this.edgeMaterial.opacity},set:function(t){this.edgeMaterial.opacity=t,this.meshMaterial.opacity=t}},{key:"update",value:function(){for(var t=this.mesh.geometry.boundsTree,e=t?t._roots.length:0;this._roots.length>e;){var n=this._roots.pop();n.geometry.dispose(),this.remove(n)}for(var r=0;r<e;r++){if(r>=this._roots.length){var i=new jt(this.mesh,this.edgeMaterial,this.depth,r);this.add(i),this._roots.push(i)}var a=this._roots[r];a.depth=this.depth,a.mesh=this.mesh,a.displayParents=this.displayParents,a.displayEdges=this.displayEdges,a.material=this.displayEdges?this.edgeMaterial:this.meshMaterial,a.update()}}},{key:"updateMatrixWorld",value:function(){var t;this.position.copy(this.mesh.position),this.rotation.copy(this.mesh.rotation),this.scale.copy(this.mesh.scale);for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];(t=(0,E.Z)((0,N.Z)(n.prototype),"updateMatrixWorld",this)).call.apply(t,[this].concat(r))}},{key:"copy",value:function(t){this.depth=t.depth,this.mesh=t.mesh}},{key:"clone",value:function(){return new n(this.mesh,this.depth)}},{key:"dispose",value:function(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();for(var t=this.children,e=0,n=t.length;e<n;e++)t[e].geometry.dispose()}}]),n}(u.Group),Kt=new u.Box3,Qt=new u.Box3,$t=new u.Vector3;function te(t){switch(typeof t){case"number":return 8;case"string":return 2*t.length;case"boolean":return 4;default:return 0}}function ee(t){return t._roots.map((function(e,n){return function(t,e){var n={nodeCount:0,leafNodeCount:0,depth:{min:1/0,max:-1/0},tris:{min:1/0,max:-1/0},splits:[0,0,0],surfaceAreaScore:0};return t.traverse((function(t,e,r,i,a){var o=r[3]-r[0],s=r[4]-r[1],u=r[5]-r[2],c=2*(o*s+s*u+u*o);n.nodeCount++,e?(n.leafNodeCount++,n.depth.min=Math.min(t,n.depth.min),n.depth.max=Math.max(t,n.depth.max),n.tris.min=Math.min(a,n.tris.min),n.tris.max=Math.max(a,n.tris.max),n.surfaceAreaScore+=c*p*a):(n.splits[i]++,n.surfaceAreaScore+=1*c)}),e),n.tris.min===1/0&&(n.tris.min=0,n.tris.max=0),n.depth.min===1/0&&(n.depth.min=0,n.depth.max=0),n}(t,n)}))}function ne(t){for(var e=new Set,n=[t],r=0;n.length;){var i=n.pop();if(!e.has(i))for(var a in e.add(i),i)if(i.hasOwnProperty(a)){r+=te(a);var o=i[a];!o||"object"!==typeof o&&"function"!==typeof o?r+=te(o):/(Uint|Int|Float)(8|16|32)Array/.test(o.constructor.name)||o instanceof ArrayBuffer?r+=o.byteLength:n.push(o)}}return r}function re(t){var e=t.geometry,n=[],r=e.index,i=e.getAttribute("position"),a=!0;return t.traverse((function(t,e,o,s,u){var c={depth:t,isLeaf:e,boundingData:o,offset:s,count:u};n[t]=c,w(0,o,Kt);var d=n[t-1];if(e)for(var f=3*s,l=3*(s+u);f<l;f+=3){var v=r.getX(f),h=r.getX(f+1),p=r.getX(f+2),y=void 0;$t.fromBufferAttribute(i,v),y=Kt.containsPoint($t),$t.fromBufferAttribute(i,h),y=y&&Kt.containsPoint($t),$t.fromBufferAttribute(i,p),y=y&&Kt.containsPoint($t),console.assert(y,"Leaf bounds does not fully contain triangle."),a=a&&y}if(d){w(0,o,Qt);var m=Qt.containsBox(Kt);console.assert(m,"Parent bounds does not fully contain child."),a=a&&m}})),a}function ie(t){var e=[];return t.traverse((function(t,n,r,i,a){var o={bounds:w(0,r,new u.Box3)};n?(o.count=a,o.offset=i):(o.left=null,o.right=null),e[t]=o;var s=e[t-1];s&&(null===s.left?s.left=o:s.right=o)})),e[0]}var ae=new u.Ray,oe=new u.Matrix4,se=u.Mesh.prototype.raycast;function ue(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;oe.copy(this.matrixWorld).invert(),ae.copy(t.ray).applyMatrix4(oe);var n=this.geometry.boundsTree;if(!0===t.firstHitOnly){var r=nt(n.raycastFirst(ae,this.material),this,t);r&&e.push(r)}else for(var i=n.raycast(ae,this.material),a=0,o=i.length;a<o;a++){var s=nt(i[a],this,t);s&&e.push(s)}}else se.call(this,t,e)}function ce(t){return this.boundsTree=new Xt(this,t),this.boundsTree}function de(){this.boundsTree=null}function fe(t){switch(t){case 1:return u.RedIntegerFormat;case 2:return u.RGIntegerFormat;case 3:case 4:return u.RGBAIntegerFormat}}var le=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(){var t;return(0,o.Z)(this,n),(t=e.call(this)).minFilter=u.NearestFilter,t.magFilter=u.NearestFilter,t.generateMipmaps=!1,t.overrideItemSize=null,t._forcedType=null,t}return(0,s.Z)(n,[{key:"updateFrom",value:function(t){var e=this.overrideItemSize,n=t.itemSize,r=t.count;if(null!==e){if(n*r%e!==0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");t.itemSize=e,t.count=r*n/e}var i,a,o,s,c=t.itemSize,d=t.count,f=t.normalized,l=t.array.constructor,v=l.BYTES_PER_ELEMENT,h=this._forcedType,p=c;if(null===h)switch(l){case Float32Array:h=u.FloatType;break;case Uint8Array:case Uint16Array:case Uint32Array:h=u.UnsignedIntType;break;case Int8Array:case Int16Array:case Int32Array:h=u.IntType}var y=function(t){switch(t){case 1:return"R";case 2:return"RG";case 3:case 4:return"RGBA"}throw new Error}(c);switch(h){case u.FloatType:o=1,a=function(t){switch(t){case 1:return u.RedFormat;case 2:return u.RGFormat;case 3:case 4:return u.RGBAFormat}}(c),f&&1===v?(s=l,y+="8",l===Uint8Array?i=u.UnsignedByteType:(i=u.ByteType,y+="_SNORM")):(s=Float32Array,y+="32F",i=u.FloatType);break;case u.IntType:y+=8*v+"I",o=f?Math.pow(2,8*l.BYTES_PER_ELEMENT-1):1,a=fe(c),1===v?(s=Int8Array,i=u.ByteType):2===v?(s=Int16Array,i=u.ShortType):(s=Int32Array,i=u.IntType);break;case u.UnsignedIntType:y+=8*v+"UI",o=f?Math.pow(2,8*l.BYTES_PER_ELEMENT-1):1,a=fe(c),1===v?(s=Uint8Array,i=u.UnsignedByteType):2===v?(s=Uint16Array,i=u.UnsignedShortType):(s=Uint32Array,i=u.UnsignedIntType)}3!==p||a!==u.RGBAFormat&&a!==u.RGBAIntegerFormat||(p=4);for(var m=Math.ceil(Math.sqrt(d)),g=new s(p*m*m),x=0;x<d;x++){var b=p*x;g[b]=t.getX(x)/o,c>=2&&(g[b+1]=t.getY(x)/o),c>=3&&(g[b+2]=t.getZ(x)/o,4===p&&(g[b+3]=1)),c>=4&&(g[b+3]=t.getW(x)/o)}this.internalFormat=y,this.format=a,this.type=i,this.image.width=m,this.image.height=m,this.image.data=g,this.needsUpdate=!0,this.dispose(),t.itemSize=n,t.count=r}}]),n}(u.DataTexture),ve=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(){var t;return(0,o.Z)(this,n),(t=e.call(this))._forcedType=u.UnsignedIntType,t}return(0,s.Z)(n)}(le),he=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(){var t;return(0,o.Z)(this,n),(t=e.call(this))._forcedType=u.IntType,t}return(0,s.Z)(n)}(le),pe=function(t){(0,_.Z)(n,t);var e=(0,G.Z)(n);function n(){var t;return(0,o.Z)(this,n),(t=e.call(this))._forcedType=u.FloatType,t}return(0,s.Z)(n)}(le);var ye=function(){function t(){(0,o.Z)(this,t),this.autoDispose=!0,this.index=new ve,this.position=new pe,this.bvhBounds=new u.DataTexture,this.bvhContents=new u.DataTexture,this.index.overrideItemSize=3}return(0,s.Z)(t,[{key:"updateFrom",value:function(t){var e=t.geometry;!function(t,e,n){var r=t._roots;if(1!==r.length)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");for(var i=r[0],a=new Uint16Array(i),o=new Uint32Array(i),s=new Float32Array(i),c=i.byteLength/y,d=2*Math.ceil(Math.sqrt(c/2)),f=new Float32Array(4*d*d),l=Math.ceil(Math.sqrt(c)),v=new Uint32Array(2*l*l),h=0;h<c;h++){for(var p=h*y/4,m=2*p,g=p,x=0;x<3;x++)f[8*h+0+x]=s[g+0+x],f[8*h+4+x]=s[g+3+x];if(vt(m,a)){var b=pt(m,a),w=ht(p,o),B=4294901760|b;v[2*h+0]=B,v[2*h+1]=w}else{var T=4*mt(p,o)/y,A=gt(p,o);v[2*h+0]=A,v[2*h+1]=T}}e.image.data=f,e.image.width=d,e.image.height=d,e.format=u.RGBAFormat,e.type=u.FloatType,e.internalFormat="RGBA32F",e.minFilter=u.NearestFilter,e.magFilter=u.NearestFilter,e.generateMipmaps=!1,e.needsUpdate=!0,e.dispose(),n.image.data=v,n.image.width=l,n.image.height=l,n.format=u.RGIntegerFormat,n.type=u.UnsignedIntType,n.internalFormat="RG32UI",n.minFilter=u.NearestFilter,n.magFilter=u.NearestFilter,n.generateMipmaps=!1,n.needsUpdate=!0,n.dispose()}(t,this.bvhBounds,this.bvhContents),this.index.updateFrom(e.index),this.position.updateFrom(e.attributes.position)}},{key:"dispose",value:function(){var t=this.index,e=this.position,n=this.bvhBounds,r=this.bvhContents;t&&t.dispose(),e&&e.dispose(),n&&n.dispose(),r&&r.dispose()}}]),t}(),me="\n#ifndef TRI_INTERSECT_EPSILON\n#define TRI_INTERSECT_EPSILON 1e-5\n#endif\n\n#ifndef INFINITY\n#define INFINITY 1e20\n#endif\n\nstruct BVH {\n\n\tusampler2D index;\n\tsampler2D position;\n\n\tsampler2D bvhBounds;\n\tusampler2D bvhContents;\n\n};\n\n// Note that a struct cannot be used for the hit record including faceIndices, faceNormal, barycoord,\n// side, and dist because on some mobile GPUS (such as Adreno) numbers are afforded less precision specifically\n// when in a struct leading to inaccurate hit results. See KhronosGroup/WebGL#3351 for more details.\n",ge="\n\nuvec4 uTexelFetch1D( usampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nivec4 iTexelFetch1D( isampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 texelFetch1D( sampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {\n\n\treturn\n\t\tbarycoord.x * texelFetch1D( tex, faceIndices.x ) +\n\t\tbarycoord.y * texelFetch1D( tex, faceIndices.y ) +\n\t\tbarycoord.z * texelFetch1D( tex, faceIndices.z );\n\n}\n\nvoid ndcToCameraRay(\n\tvec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,\n\tout vec3 rayOrigin, out vec3 rayDirection\n) {\n\n\t// get camera look direction and near plane for camera clipping\n\tvec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );\n\tvec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );\n\tfloat near = abs( nearVector.z / nearVector.w );\n\n\t// get the camera direction and position from camera matrices\n\tvec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );\n\tdirection /= direction.w;\n\tdirection = cameraWorld * direction - origin;\n\n\t// slide the origin along the ray until it sits at the near clip plane position\n\torigin.xyz += direction.xyz * near / dot( direction, lookDirection );\n\n\trayOrigin = origin.xyz;\n\trayDirection = direction.xyz;\n\n}\n\nfloat intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax ) {\n\n\t// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/\n\t// https://tavianator.com/2011/ray_box.html\n\tvec3 invDir = 1.0 / rayDirection;\n\n\t// find intersection distances for each plane\n\tvec3 tMinPlane = invDir * ( boundsMin - rayOrigin );\n\tvec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );\n\n\t// get the min and max distances from each intersection\n\tvec3 tMinHit = min( tMaxPlane, tMinPlane );\n\tvec3 tMaxHit = max( tMaxPlane, tMinPlane );\n\n\t// get the furthest hit distance\n\tvec2 t = max( tMinHit.xx, tMinHit.yz );\n\tfloat t0 = max( t.x, t.y );\n\n\t// get the minimum hit distance\n\tt = min( tMaxHit.xx, tMaxHit.yz );\n\tfloat t1 = min( t.x, t.y );\n\n\t// set distance to 0.0 if the ray starts inside the box\n\tfloat dist = max( t0, 0.0 );\n\n\treturn t1 >= dist ? dist : INFINITY;\n\n}\n\nbool intersectsTriangle(\n\tvec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,\n\tout vec3 barycoord, out vec3 norm, out float dist, out float side\n) {\n\n\t// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d\n\tvec3 edge1 = b - a;\n\tvec3 edge2 = c - a;\n\tnorm = cross( edge1, edge2 );\n\n\tfloat det = - dot( rayDirection, norm );\n\tfloat invdet = 1.0 / det;\n\n\tvec3 AO = rayOrigin - a;\n\tvec3 DAO = cross( AO, rayDirection );\n\n\tvec4 uvt;\n\tuvt.x = dot( edge2, DAO ) * invdet;\n\tuvt.y = - dot( edge1, DAO ) * invdet;\n\tuvt.z = dot( AO, norm ) * invdet;\n\tuvt.w = 1.0 - uvt.x - uvt.y;\n\n\t// set the hit information\n\tbarycoord = uvt.wxy; // arranged in A, B, C order\n\tdist = uvt.z;\n\tside = sign( det );\n\tnorm = side * normalize( norm );\n\n\t// add an epsilon to avoid misses between triangles\n\tuvt += vec4( TRI_INTERSECT_EPSILON );\n\n\treturn all( greaterThanEqual( uvt, vec4( 0.0 ) ) );\n\n}\n\nbool intersectTriangles(\n\tBVH bvh, vec3 rayOrigin, vec3 rayDirection, uint offset, uint count,\n\tinout float minDistance,\n\n\t// output variables\n\tout uvec4 faceIndices, out vec3 faceNormal, out vec3 barycoord,\n\tout float side, out float dist\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord, localNormal;\n\tfloat localDist, localSide;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( bvh.index, i ).xyz;\n\t\tvec3 a = texelFetch1D( bvh.position, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( bvh.position, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( bvh.position, indices.z ).rgb;\n\n\t\tif (\n\t\t\tintersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )\n\t\t\t&& localDist < minDistance\n\t\t) {\n\n\t\t\tfound = true;\n\t\t\tminDistance = localDist;\n\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = localNormal;\n\n\t\t\tside = localSide;\n\t\t\tbarycoord = localBarycoord;\n\t\t\tdist = localDist;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\nfloat intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, BVH bvh, uint currNodeIndex ) {\n\n\tvec3 boundsMin = texelFetch1D( bvh.bvhBounds, currNodeIndex * 2u + 0u ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvh.bvhBounds, currNodeIndex * 2u + 1u ).xyz;\n\treturn intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax );\n\n}\n\nbool bvhIntersectFirstHit(\n\tBVH bvh, vec3 rayOrigin, vec3 rayDirection,\n\n\t// output variables\n\tout uvec4 faceIndices, out vec3 faceNormal, out vec3 barycoord,\n\tout float side, out float dist\n) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ 60 ];\n\tstack[ 0 ] = 0u;\n\n\tfloat triangleDistance = 1e20;\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < 60 ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance = intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh, currNodeIndex );\n\t\tif ( boundsHitDistance == INFINITY || boundsHitDistance > triangleDistance ) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh.bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\n\t\t\tfound = intersectTriangles(\n\t\t\t\tbvh, rayOrigin, rayDirection, offset, count, triangleDistance,\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, dist\n\t\t\t) || found;\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = boundsInfo.y;\n\n\t\t\tbool leftToRight = rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\n",xe=new u.Vector3,be=new u.Vector3,we=new u.Vector3,Be=new u.Vector4,Te=new u.Vector3,Ae=new u.Vector3,Me=new u.Vector4,Ie=new u.Vector4,Pe=new u.Matrix4,Fe=new u.Matrix4;function Se(t,e){if(t||e){var n=t.count===e.count,r=t.normalized===e.normalized,i=t.array.constructor===e.array.constructor,a=t.itemSize===e.itemSize;if(!n||!r||!i||!a)throw new Error}}function Ve(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=t.array.constructor,r=t.normalized,i=t.itemSize,a=null===e?t.count:e;return new u.BufferAttribute(new n(i*a),i,r)}function ke(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(t.isInterleavedBufferAttribute)for(var r=t.itemSize,i=0,a=t.count;i<a;i++){var o=i+n;e.setX(o,t.getX(i)),r>=2&&e.setY(o,t.getY(i)),r>=3&&e.setZ(o,t.getZ(i)),r>=4&&e.setW(o,t.getW(i))}else{var s=e.array,u=s.constructor,c=s.BYTES_PER_ELEMENT*t.itemSize*n,d=new u(s.buffer,c,t.array.length);d.set(t.array)}}function De(t,e,n){for(var r=t.elements,i=e.elements,a=0,o=i.length;a<o;a++)r[a]+=i[a]*n}function Ue(t,e,n){var r=t.skeleton,i=t.geometry,a=r.bones,o=r.boneInverses;Me.fromBufferAttribute(i.attributes.skinIndex,e),Ie.fromBufferAttribute(i.attributes.skinWeight,e),Pe.elements.fill(0);for(var s=0;s<4;s++){var u=Ie.getComponent(s);if(0!==u){var c=Me.getComponent(s);Fe.multiplyMatrices(a[c].matrixWorld,o[c]),De(Pe,Fe,u)}}return Pe.multiply(t.bindMatrix).premultiply(t.bindMatrixInverse),n.transformDirection(Pe),n}function ze(t,e,n,r,i){Te.set(0,0,0);for(var a=0,o=t.length;a<o;a++){var s=e[a],u=t[a];0!==s&&(Ae.fromBufferAttribute(u,r),n?Te.addScaledVector(Ae,s):Te.addScaledVector(Ae.sub(i),s))}i.add(Te)}function Ze(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{useGroups:!1,updateIndex:!1},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new u.BufferGeometry,r=null!==t[0].index,i=e.useGroups,a=e.updateIndex,o=new Set(Object.keys(t[0].attributes)),s={},c=0,d=0;d<t.length;++d){var f=t[d],l=0;if(r!==(null!==f.index))throw new Error("StaticGeometryGenerator: All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");for(var v in f.attributes){if(!o.has(v))throw new Error('StaticGeometryGenerator: All geometries must have compatible attributes; make sure "'+v+'" attribute exists among all geometries, or in none of them.');void 0===s[v]&&(s[v]=[]),s[v].push(f.attributes[v]),l++}if(l!==o.size)throw new Error("StaticGeometryGenerator: Make sure all geometries have the same number of attributes.");if(i){var h=void 0;if(r)h=f.index.count;else{if(void 0===f.attributes.position)throw new Error("StaticGeometryGenerator: The geometry must have either an index or a position attribute");h=f.attributes.position.count}n.addGroup(c,h,d),c+=h}}if(r){var p=!1;if(!n.index){for(var y=0,m=0;m<t.length;++m)y+=t[m].index.count;n.setIndex(new u.BufferAttribute(new Uint32Array(y),1,!1)),p=!0}if(a||p)for(var g=n.index,x=0,b=0,w=0;w<t.length;++w){for(var B=t[w],T=B.index,A=0;A<T.count;++A)g.setX(x,T.getX(A)+b),x++;b+=B.attributes.position.count}}for(var M in s){var I=s[M];if(!(M in n.attributes)){var P=0;for(var F in I)P+=I[F].count;n.setAttribute(M,Ve(s[M][0],P))}var S=n.attributes[M],V=0;for(var k in I){var D=I[k];ke(D,S,V),V+=D.count}}return n}var Ee=function(){function t(e){(0,o.Z)(this,t),Array.isArray(e)||(e=[e]);var n=[];e.forEach((function(t){t.traverse((function(t){t.isMesh&&n.push(t)}))})),this.meshes=n,this.useGroups=!0,this.applyWorldTransforms=!0,this.attributes=["position","normal","tangent","uv","uv2"],this._intermediateGeometry=new Array(n.length).fill().map((function(){return new u.BufferGeometry}))}return(0,s.Z)(t,[{key:"getMaterials",value:function(){var t=[];return this.meshes.forEach((function(e){Array.isArray(e.material)?t.push.apply(t,(0,x.Z)(e.material)):t.push(e.material)})),t}},{key:"generate",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new u.BufferGeometry,e=this.meshes,n=this.useGroups,r=this._intermediateGeometry,i=0,a=e.length;i<a;i++){var o=e[i],s=r[i];this._convertToStaticGeometry(o,s)}for(var c in Ze(r,{useGroups:n},t),t.attributes)t.attributes[c].needsUpdate=!0;return t}},{key:"_convertToStaticGeometry",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new u.BufferGeometry,n=t.geometry,r=this.applyWorldTransforms,i=this.attributes.includes("normal"),a=this.attributes.includes("tangent"),o=n.attributes,s=e.attributes;e.index||(e.index=n.index),s.position||e.setAttribute("position",Ve(o.position)),i&&!s.normal&&o.normal&&e.setAttribute("normal",Ve(o.normal)),a&&!s.tangent&&o.tangent&&e.setAttribute("tangent",Ve(o.tangent)),Se(n.index,e.index),Se(o.position,s.position),i&&Se(o.normal,s.normal),a&&Se(o.tangent,s.tangent);var c=o.position,d=i?o.normal:null,f=a?o.tangent:null,l=n.morphAttributes.position,v=n.morphAttributes.normal,h=n.morphAttributes.tangent,p=n.morphTargetsRelative,y=t.morphTargetInfluences,m=new u.Matrix3;m.getNormalMatrix(t.matrixWorld);for(var g=0,x=o.position.count;g<x;g++)xe.fromBufferAttribute(c,g),d&&be.fromBufferAttribute(d,g),f&&(Be.fromBufferAttribute(f,g),we.fromBufferAttribute(f,g)),y&&(l&&ze(l,y,p,g,xe),v&&ze(v,y,p,g,be),h&&ze(h,y,p,g,we)),t.isSkinnedMesh&&(t.boneTransform(g,xe),d&&Ue(t,g,be),f&&Ue(t,g,we)),r&&xe.applyMatrix4(t.matrixWorld),s.position.setXYZ(g,xe.x,xe.y,xe.z),d&&(r&&be.applyNormalMatrix(m),s.normal.setXYZ(g,be.x,be.y,be.z)),f&&(r&&we.transformDirection(t.matrixWorld),s.tangent.setXYZW(g,we.x,we.y,we.z,Be.w));for(var b in this.attributes){var w=this.attributes[b];"position"!==w&&"tangent"!==w&&"normal"!==w&&w in o&&(s[w]||e.setAttribute(w,Ve(o[w])),Se(o[w],s[w]),ke(o[w],s[w]))}return e}}]),t}()}}]);
//# sourceMappingURL=797.bundle.js.map